# X86堆栈

## 内平栈/外平栈


```
callq  0xffffffffaf98f930 <__crash_kexec>
```

* callq 跳转，先把下一个指令地址放到栈中，然后就是0xffffffffaf98f930代码处执行
* 0xffffffffaf98f930，自行处理压入参数，弹bp，修正sp，保持堆栈平衡
* 函数自己出创建栈自己完成栈平衡操作


```
push bp // 保存bp指针
mov bp,sp   // sp指向bp，此时sp与bp平起平坐，栈顶=栈底
push A
push B
push C
push D       // sp向下延伸，bp保持不动
```


```
函数结束时
mov sp,bp   // 将sp打回原形，回退到bp状态，实则为调用者的栈顶
pop bp      // 与此同时bp也要打回原形，回退到调用者的栈底
ret
```


## demo

```
long myfunc(long a, long b, long c, long d,
            long e, long f, long g, long h)
{
    long xx = a * b * c * d * e * f * g * h;
    long yy = a + b + c + d + e + f + g + h;
    long zz = utilfunc(xx, yy, xx % yy);
    return zz + 20;
}
```

![20220401_203558_75](image/20220401_203558_75.png)




## 参考

* <https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64/>

---
